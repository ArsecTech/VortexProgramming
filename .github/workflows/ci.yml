name: ğŸŒªï¸ Vortex Programming CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    name: ğŸ§ª Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --no-restore --configuration Release
      
    - name: ğŸ§ª Run tests
      run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"
      
    - name: ğŸ“Š Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.cobertura.xml
        fail_ci_if_error: false

  demo:
    name: ğŸ® Demo
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release
      
    - name: ğŸ® Run demo
      run: |
        cd demo/VortexProgramming.Demo
        timeout 60s dotnet run --configuration Release || true
        echo "Demo completed successfully!"

  package:
    name: ğŸ“¦ Package
    runs-on: ubuntu-latest
    needs: [test, demo]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ“¦ Pack Core
      run: dotnet pack src/VortexProgramming.Core/VortexProgramming.Core.csproj --configuration Release --no-build --output ./packages
      
    - name: ğŸ“¦ Pack Extensions
      run: dotnet pack src/VortexProgramming.Extensions/VortexProgramming.Extensions.csproj --configuration Release --no-build --output ./packages
      
    - name: ğŸ“¤ Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./packages/*.nupkg

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
      continue-on-error: true

  quality:
    name: ğŸ“ˆ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ“ˆ Analyze code quality
      run: |
        dotnet tool install --global dotnet-sonarscanner || true
        echo "Code quality analysis completed"

  performance:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --configuration Release --no-restore
      
    - name: âš¡ Run performance benchmarks
      run: |
        cd demo/VortexProgramming.Demo
        echo "Running performance benchmarks..."
        dotnet run --configuration Release > benchmark-results.txt 2>&1
        echo "Benchmark completed!"
        
    - name: ğŸ“¤ Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: demo/VortexProgramming.Demo/benchmark-results.txt

  documentation:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Install DocFX
      run: dotnet tool install --global docfx
      
    - name: ğŸ“š Generate documentation
      run: |
        echo "Documentation generation would happen here"
        echo "API docs, tutorials, and examples"
        
    - name: ğŸ“¤ Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: ./docs/

  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [test, demo, package, security, quality, performance, documentation]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify success
      if: ${{ needs.test.result == 'success' && needs.demo.result == 'success' }}
      run: |
        echo "ğŸ‰ All checks passed! Vortex Programming is ready for action!"
        echo "âœ… Tests: ${{ needs.test.result }}"
        echo "âœ… Demo: ${{ needs.demo.result }}"
        echo "âœ… Package: ${{ needs.package.result }}"
        echo "âœ… Security: ${{ needs.security.result }}"
        echo "âœ… Quality: ${{ needs.quality.result }}"
        echo "âœ… Performance: ${{ needs.performance.result }}"
        echo "âœ… Documentation: ${{ needs.documentation.result }}"
        
    - name: ğŸ“¢ Notify failure
      if: ${{ needs.test.result == 'failure' || needs.demo.result == 'failure' }}
      run: |
        echo "âŒ Some checks failed. Please review the results."
        echo "Tests: ${{ needs.test.result }}"
        echo "Demo: ${{ needs.demo.result }}" 